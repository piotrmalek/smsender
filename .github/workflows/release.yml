name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Publish CLI (win-x64, single-file, self-contained)
        shell: pwsh
        run: |
          dotnet publish .\src\smsender-cli\smsender-cli.csproj `
            -c Release -r win-x64 --self-contained true -o .\artifacts\cli `
            /p:PublishSingleFile=true /p:PublishTrimmed=false

      - name: Publish GUI (win-x64, single-file, self-contained)
        shell: pwsh
        run: |
          dotnet publish .\src\smsender-gui\smsender-gui.csproj `
            -c Release -r win-x64 --self-contained true -o .\artifacts\gui `
            /p:PublishSingleFile=true /p:PublishTrimmed=false

      - name: Add README to packages
        shell: pwsh
        run: |
          Copy-Item README.md ".\artifacts\cli\README.txt"
          Copy-Item README.md ".\artifacts\gui\README.txt"

      - name: Package ZIP + SHA256
        shell: pwsh
        run: |
          $cliZip = "smsender-win-x64-cli.zip"
          $guiZip = "smsender-win-x64-gui.zip"

          if (Test-Path $cliZip) { Remove-Item $cliZip }
          if (Test-Path $guiZip) { Remove-Item $guiZip }

          Compress-Archive -Path ".\artifacts\cli\*" -DestinationPath $cliZip
          Compress-Archive -Path ".\artifacts\gui\*" -DestinationPath $guiZip

          $cliHash = (Get-FileHash $cliZip -Algorithm SHA256).Hash
          $guiHash = (Get-FileHash $guiZip -Algorithm SHA256).Hash

          @(
            "$cliHash  $cliZip",
            "$guiHash  $guiZip"
          ) | Out-File SHA256SUMS.txt -Encoding ascii

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            smsender-win-x64-cli.zip
            smsender-win-x64-gui.zip
            SHA256SUMS.txt
            README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
